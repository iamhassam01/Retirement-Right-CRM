// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Users & Auth ---
model User {
  id          String   @id @default(uuid())
  email       String   @unique
  password    String // Hashed
  name        String
  role        Role     @default(ADVISOR)
  isAvailable Boolean  @default(true) // For Vapi availability check
  phone       String?  // For call transfers
  avatar      String?  // Profile picture URL
  title       String?  // Job title (e.g., "Senior Advisor")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  clients Client[]
  tasks   Task[]
  events  Event[]
  notifications Notification[]
  notes   Note[]   // Notes authored by this user
  timeBlocks TimeBlock[] // Time blocks for calendar availability
}

enum Role {
  ADMIN
  ADVISOR
  STAFF
}

// --- Clients & Leads ---
model Client {
  id            String  @id @default(uuid())
  clientId      String? @unique // Human-readable ID (e.g., CL-0001), optional for backwards compat
  name          String
  email         String? @map("legacy_email") // Deprecated, kept for migration
  phone         String? @map("legacy_phone") // Deprecated, kept for migration
  status        String // e.g., "Active", "Prospect", "Lead"
  pipelineStage String? // e.g., "New Lead", "Contacted"

  advisorId String?
  advisor   User?   @relation(fields: [advisorId], references: [id])

  // Financial & Profile Info
  aum             Float?   @default(0)
  riskProfile     String? // "Conservative", "Moderate", etc.
  portfolioHealth String? // "On Track", "Review Needed"
  tags            String[] // ["Retiree", "Golfer"]
  imageUrl        String?

  // Retirement Planning Fields
  dateOfBirth       DateTime?
  retirementDate    DateTime?
  ssaEligibilityAge Int? // 62, 65, 67, 70
  spouseName        String?
  spouseDOB         DateTime?
  beneficiaries     Json? // Array of {name, relationship, percentage}

  // Additional Financial Details
  annualIncome    Float?
  netWorth        Float?
  monthlyExpenses Float?
  riskScore       Int? // 1-10 scale

  // Timestamps
  lastContact DateTime?
  nextStep    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  activities Activity[]
  events     Event[]
  tasks      Task[]
  documents  Document[]
  communicationLogs CommunicationLog[]
  phones     ClientPhone[]
  emails     ClientEmail[]
  notes      Note[]    // Notes for this client
}

// --- Phone Type Enumeration ---
enum PhoneType {
  HOME
  WORK
  CELLULAR
  OTHER
}

// --- Email Type Enumeration ---
enum EmailType {
  HOME
  HOME2
  WORK
  PERSONAL
  OTHER
}

// --- Multiple Phone Numbers per Client ---
model ClientPhone {
  id        String    @id @default(uuid())
  clientId  String
  client    Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  number    String
  type      PhoneType @default(CELLULAR)
  label     String?   // Custom label like "Main Office"
  isPrimary Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([clientId])
}

// --- Multiple Email Addresses per Client ---
model ClientEmail {
  id        String    @id @default(uuid())
  clientId  String
  client    Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  email     String
  type      EmailType @default(PERSONAL)
  label     String?   // Custom label
  isPrimary Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([clientId])
}

// --- Import Job Tracking ---
model ImportJob {
  id             String    @id @default(uuid())
  filename       String
  totalRecords   Int
  processedCount Int       @default(0)
  successCount   Int       @default(0)
  errorCount     Int       @default(0)
  skippedCount   Int       @default(0)
  status         String    @default("pending") // pending, processing, completed, failed
  errors         Json?     // Array of error objects
  mappings       Json?     // Column mappings used
  createdAt      DateTime  @default(now())
  completedAt    DateTime?
}

// --- Activities (Calls, Emails, AI Logs) ---
model Activity {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  type      String // "call", "sms", "email", "meeting"
  subType   String? // "ai", "human"
  direction String? // "inbound", "outbound"
  user      String? // "AI Assistant", "John Jenkins"

  description String?
  date        DateTime @default(now())
  duration    String? // "4m 12s"
  status      String? // "Completed", "Voicemail"

  // AI & Vapi Specifics
  aiAnalysis   Json? // Stores summary, intent, sentiment, confidence
  transcript   Json? // Stores array of speaker/text objects
  recordingUrl String? // URL to audio file

  createdAt DateTime @default(now())
}

// --- Calendar & Events ---
model Event {
  id        String   @id @default(uuid())
  title     String
  startTime DateTime
  endTime   DateTime
  type      String // "Meeting", "Workshop", "Call"
  status    String   @default("Scheduled") // "Scheduled", "Completed", "Cancelled"

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  advisorId String?
  advisor   User?   @relation(fields: [advisorId], references: [id])

  // Workshop specifics
  capacity   Int?
  registered Int?    @default(0)
  location   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- Tasks & Follow-ups ---
model Task {
  id          String    @id @default(uuid())
  title       String
  description String?
  dueDate     DateTime?
  priority    String    @default("Medium") // "High", "Medium", "Low"
  status      String    @default("Pending") // "Pending", "Completed"
  type        String? // "Call", "Email", "Prep"

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- Documents ---
model Document {
  id       String  @id @default(uuid())
  name     String
  type     String // "pdf", "docx"
  size     String?
  url      String // Path or S3 URL
  category String? // "Client", "Compliance"

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- System Settings ---
model Settings {
  id        String   @id @default(uuid())
  key       String   @unique // e.g., "pipeline_stages"
  value     Json // Stores configuration
  updatedAt DateTime @updatedAt
}

// --- Communication Templates ---
model Template {
  id          String   @id @default(uuid())
  name        String
  type        String   // "Email" or "SMS"
  subject     String?
  body        String
  variables   String[] // ["client_name", "advisor_name"]
  usageCount  Int      @default(0)
  lastUsedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  logs           CommunicationLog[]
  automationLogs AutomationLog[] @relation("AutomationLogs")
}

// --- Communication Logs ---
model CommunicationLog {
  id          String    @id @default(uuid())
  recipientId String?
  recipient   Client?   @relation(fields: [recipientId], references: [id])
  templateId  String?
  template    Template? @relation(fields: [templateId], references: [id])
  channel     String    // "Email", "SMS"
  status      String    // "Delivered", "Opened", "Replied", "Failed"
  sentAt      DateTime  @default(now())
  metadata    Json?
}

// --- Automation Batch Logs ---
model AutomationLog {
  id             String    @id @default(uuid())
  templateId     String
  template       Template  @relation(fields: [templateId], references: [id], name: "AutomationLogs")
  recipientCount Int
  sentCount      Int       @default(0)
  failedCount    Int       @default(0)
  status         String    @default("pending") // pending, sending, completed, partial, failed
  errorDetails   Json?
  createdAt      DateTime  @default(now())
  completedAt    DateTime?
}

// --- Notifications ---
model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // "new_lead", "portfolio_drop", "workshop_registration", "reminder", "system"
  title     String
  message   String
  link      String?  // Optional link to navigate to
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

// --- Client Notes ---
model Note {
  id        String   @id @default(uuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  
  title     String?
  content   String
  category  String?  // "General", "Meeting", "Call", "Financial", "Personal"
  isPinned  Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([clientId])
}

// --- Time Blocking (Calendar Availability) ---
model TimeBlock {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  title       String?  // "Lunch", "Personal Time", etc.
  type        String   @default("busy") // "busy", "personal", "out_of_office"
  
  startTime   DateTime
  endTime     DateTime
  
  // Recurrence
  isRecurring Boolean  @default(false)
  recurrenceRule String? // e.g., "WEEKLY:MON,WED,FRI" or null for one-time
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([startTime, endTime])
}

// --- Event Templates (Shared Workshop Content) ---
// Represents a workshop "type" like "Maximizing Social Security"
model EventTemplate {
  id          String   @id @default(uuid())
  name        String   // Internal name: "Maximizing Social Security"
  slug        String?  @unique // URL-friendly slug for WordPress
  isActive    Boolean  @default(true)
  
  // Display Content
  subtitle    String?  // "Maximize Your Benefits"
  description String?  @db.Text // Short description/excerpt
  
  // What You'll Learn (array of bullet points)
  learnings   String[]
  
  // Why Attend (rich text)
  whyAttend   String?  @db.Text
  
  // FAQs (array of {question, answer})
  faqs        Json?
  
  // Host Information (template-based, same for all occurrences)
  hostName    String?
  hostTitle   String?
  hostEmail   String?
  hostPhone   String?
  
  // Additional Content
  guideUrl    String?  // Downloadable guide PDF
  disclaimer  String?  @db.Text // Privacy disclaimer
  
  // Default Settings
  defaultCapacity  Int?     @default(20)
  defaultDuration  Int?     @default(120) // Minutes
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  occurrences EventOccurrence[]
}

// --- Event Occurrences (Specific Date/Location Instances) ---
// Each occurrence = one WordPress post
model EventOccurrence {
  id          String   @id @default(uuid())
  templateId  String
  template    EventTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  // Specific Date & Time
  eventDate   DateTime
  startTime   String?  // "6:00 PM" - display format
  endTime     String?  // "8:00 PM" - display format
  
  // Location Details
  venueName   String
  room        String?  // "Assembly Room", "Monsoon Room"
  address     String
  city        String?
  state       String?
  zipCode     String?
  mapUrl      String?  // Google Maps link
  
  // Event-specific
  capacity    Int?
  registered  Int?     @default(0)
  heroImage   String?  // Featured image URL
  
  // Status
  status      String   @default("scheduled") // scheduled, completed, cancelled
  
  // WordPress Sync
  wpPostId    Int?     @unique // WordPress post ID after sync
  wpStatus    String?  @default("draft") // draft, publish
  wpSyncStatus String? @default("pending") // pending, synced, failed
  wpLastSyncedAt DateTime?
  wpSyncError String?
  wpSlug      String?  // Generated slug with date
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([templateId])
  @@index([eventDate])
  @@index([wpPostId])
}
